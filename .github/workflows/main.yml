name: PC-V1-Ultra-Stable

on:
  workflow_dispatch:
    inputs:
      runtime:
        description: 'Uptime Duration'
        required: true
        default: '24'
        type: choice
        options:
        - 6
        - 12
        - 24

env:
  RUNTIME_HOURS: ${{ github.event.inputs.runtime || '24' }}

jobs:
  stable-rdp:
    runs-on: windows-latest
    timeout-minutes: ${{ env.RUNTIME_HOURS * 60 }}

    steps:
    - name: âš¡ System Optimization
      shell: powershell
      run: |
        Write-Host "=== SYSTEM OPTIMIZATION ==="
        
        # Power settings
        powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        powercfg /change standby-timeout-ac 0
        powercfg /change monitor-timeout-ac 0
        powercfg /hibernate off
        
        # Network optimization
        netsh int tcp set global autotuninglevel=normal
        netsh int tcp set global rss=enabled
        
        Write-Host "Optimization completed"

    - name: ğŸ–¥ï¸ Configure RDP
      shell: powershell
      run: |
        Write-Host "=== RDP CONFIGURATION ==="
        
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
        
        # Firewall rule
        netsh advfirewall firewall add rule name="PC-V1-RDP" dir=in action=allow protocol=TCP localport=3389
        
        # Restart service
        Restart-Service -Name TermService -Force
        
        echo "RDP_PORT=3389" >> $env:GITHUB_ENV
        Write-Host "RDP configured"

    - name: ğŸ‘¤ Create User
      shell: powershell
      run: |
        Write-Host "=== USER CREATION ==="
        
        # Simple password generation
        $chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@'
        $password = ''
        for ($i = 0; $i -lt 12; $i++) {
            $password += $chars[(Get-Random -Maximum $chars.Length)]
        }
        
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force
        
        # Remove existing user
        $existingUser = Get-LocalUser -Name "PC-V1" -ErrorAction SilentlyContinue
        if ($existingUser) {
            Remove-LocalUser -Name "PC-V1"
            Start-Sleep -Seconds 2
        }
        
        # Create new user
        New-LocalUser -Name "PC-V1" -Password $securePass -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "PC-V1"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "PC-V1"
        
        echo "PCV1_PASSWORD=$password" >> $env:GITHUB_ENV
        Write-Host "User created"

    - name: ğŸŒ Install Tailscale
      shell: powershell
      run: |
        Write-Host "=== INSTALLING TAILSCALE ==="
        
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
        Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
        Remove-Item $installerPath -Force
        
        Start-Sleep -Seconds 10
        Write-Host "Tailscale installed"

    - name: ğŸ”— Connect Tailscale
      shell: powershell
      run: |
        Write-Host "=== CONNECTING TAILSCALE ==="
        
        Start-Service -Name "Tailscale" -ErrorAction SilentlyContinue
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=pc-v1-stable
        
        # Get IP
        $tsIP = $null
        for ($i = 1; $i -le 10; $i++) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($tsIP -and $tsIP -match '^\d+\.\d+\.\d+\.\d+$') { break }
            Start-Sleep -Seconds 3
        }
        
        if ($tsIP) {
            echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
            Write-Host "Tailscale IP: $tsIP"
        } else {
            Write-Host "Warning: Could not get Tailscale IP"
            echo "TAILSCALE_IP=unknown" >> $env:GITHUB_ENV
        }

    - name: âœ… Verify Connection
      shell: powershell
      run: |
        Write-Host "=== VERIFICATION ==="
        
        if ($env:TAILSCALE_IP -ne "unknown") {
            $test = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -InformationLevel Quiet
            if ($test) {
                Write-Host "âœ“ Connection successful"
            } else {
                Write-Host "âš ï¸ Connection test failed"
            }
        }

    - name: ğŸ“Š Final Setup
      shell: powershell
      run: |
        Write-Host ""
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host "           PC-V1 ULTRA STABLE         "
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host "ğŸŒ Address:  $env:TAILSCALE_IP"
        Write-Host "ğŸ‘¤ Username: PC-V1"
        Write-Host "ğŸ” Password: $env:PCV1_PASSWORD"
        Write-Host "â° Runtime:  ${{ env.RUNTIME_HOURS }}h"
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host ""
        Write-Host "ğŸ® Untuk Moonlight:"
        Write-Host "â€¢ Address: $env:TAILSCALE_IP"
        Write-Host "â€¢ Username: PC-V1"
        Write-Host "â€¢ Password: $env:PCV1_PASSWORD"
        Write-Host "â€¢ GameStream mode"
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: ğŸ›¡ï¸ Keep Alive
      shell: powershell
      run: |
        Write-Host "=== KEEP ALIVE ==="
        Write-Host "PC-V1 Stable aktif selama ${{ env.RUNTIME_HOURS }} jam"
        Write-Host "IP: $env:TAILSCALE_IP"
        Write-Host ""
        
        $endTime = (Get-Date).AddHours(${{ env.RUNTIME_HOURS }})
        $checkCount = 0
        
        while ((Get-Date) -lt $endTime) {
            $checkCount++
            $remaining = $endTime - (Get-Date)
            
            Write-Host "[$(Get-Date -Format 'HH:mm')] Check #$checkCount - $([math]::Round($remaining.TotalHours, 1)) jam tersisa"
            
            # Simple health check
            $rdpStatus = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
            $tsStatus = Get-Service -Name "Tailscale" -ErrorAction SilentlyContinue
            Write-Host "  Status: RDP=$($rdpStatus.Status) Tailscale=$($tsStatus.Status)"
            
            Start-Sleep -Seconds 600  # Check every 10 minutes
        }
        
        Write-Host "Session selesai - ${{ env.RUNTIME_HOURS }} jam completed"