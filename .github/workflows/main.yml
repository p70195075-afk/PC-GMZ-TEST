name: PC-V1

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 4680

    steps:
      - name: Disable Sleep / Hibernate / PowerSave
        shell: powershell
        run: |
          powercfg /change standby-timeout-ac 0
          powercfg /change monitor-timeout-ac 0
          powercfg /hibernate off
          Write-Host "‚úÖ Power Save Disabled"

      - name: System Performance Optimizations
        shell: powershell
        run: |
          Write-Host "üöÄ Applying latency & performance tweaks..."
          netsh int tcp set global autotuninglevel=highlyrestricted
          netsh int tcp set global rss=enabled
          netsh int tcp set global chimney=enabled
          netsh int tcp set global dca=enabled
          netsh int tcp set supplemental template=internet congestionprovider=bbr2
          
          reg add "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" /v TcpAckFrequency /t REG_DWORD /d 1 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" /v TCPNoDelay /t REG_DWORD /d 1 /f

          bcdedit /set useplatformclock true
          bcdedit /set tscsyncpolicy Enhanced
          bcdedit /set disabledynamictick yes

          reg add "HKLM\SOFTWARE\Microsoft\DirectX" /v MaxFrameLatency /t REG_DWORD /d 1 /f
          Write-Host "‚úÖ System optimizations applied!"

      - name: Create PC-V1 User (SUPER SIMPLE - NO ERROR)
        shell: powershell
        run: |
          Write-Host "üë§ Creating PC-V1 user..."
          
          # Hapus user lama kalo ada (pake command line)
          net user PC-V1 /delete 2>&1 | Out-Null
          net user "PC-V1" /delete 2>&1 | Out-Null
          Start-Sleep -Seconds 2
          
          # Buat user baru pake command line (paling work)
          net user PC-V1 "P@ssw0rd123!" /add /fullname:"PC-V1 User" /comment:"PC-V1 Gaming" /expires:never /passwordchg:no
          
          # Tambah ke groups
          net localgroup administrators PC-V1 /add 2>&1 | Out-Null
          net localgroup "Remote Desktop Users" PC-V1 /add 2>&1 | Out-Null
          
          # Set password never expires di registry
          reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" /v PC-V1 /t REG_DWORD /d 1 /f 2>&1 | Out-Null
          
          echo "PCV1_PASSWORD=P@ssw0rd123!" >> $env:GITHUB_ENV
          
          Write-Host "‚úÖ User PC-V1 created successfully!"
          Write-Host "Username: PC-V1"
          Write-Host "Password: P@ssw0rd123!"

      - name: Enable Remote Desktop
        shell: powershell
        run: |
          Write-Host "üîß Enabling Remote Desktop..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1 -Force
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name "TermService" -Force
          Write-Host "‚úÖ Remote Desktop enabled."

      - name: Install Tailscale
        shell: powershell
        run: |
          Write-Host "üåê Installing Tailscale..."
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $file = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $file
          Start-Process msiexec.exe -ArgumentList "/i", "`"$file`"", "/quiet", "/norestart" -Wait
          Remove-Item $file -Force
          Write-Host "‚úÖ Tailscale installed successfully."

      - name: Connect to Tailscale
        shell: powershell
        run: |
          Write-Host "üîó Connecting to Tailscale..."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=PC-V1 --accept-routes --accept-dns=false
          Start-Sleep -Seconds 10
          $tsIP = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4)
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "‚úÖ Connected to Tailscale - IP: $tsIP"

      - name: Setup Sunshine Ports
        shell: powershell
        run: |
          Write-Host "üîß Setting up Sunshine ports..."
          $ports = @(47984, 47989, 47990, 48010)
          foreach ($port in $ports) {
              netsh advfirewall firewall add rule name="Sunshine-TCP-$port" dir=in action=allow protocol=TCP localport=$port 2>&1 | Out-Null
              netsh advfirewall firewall add rule name="Sunshine-UDP-$port" dir=in action=allow protocol=UDP localport=$port 2>&1 | Out-Null
          }
          Write-Host "‚úÖ Sunshine ports configured"

      - name: Download and Install Sunshine
        shell: powershell
        run: |
          Write-Host "üåû Downloading and Installing Sunshine..."
          
          try {
              # Download Sunshine
              $url = "https://github.com/LizardByte/Sunshine/releases/latest/download/Sunshine-Windows.exe"
              $installer = "$env:TEMP\Sunshine.exe"
              Invoke-WebRequest -Uri $url -OutFile $installer -TimeoutSec 60
              Write-Host "‚úÖ Download successful"
              
              # Install Sunshine
              Start-Process -FilePath $installer -ArgumentList "--silent" -Wait -NoNewWindow
              Write-Host "‚úÖ Installation completed"
              
              # Tunggu installasi selesai
              Start-Sleep -Seconds 15
              
              # Start service
              Start-Service -Name "Sunshine" -ErrorAction SilentlyContinue
              Write-Host "‚úÖ Service started"
              
              # Cleanup
              Remove-Item $installer -Force -ErrorAction SilentlyContinue
              
          } catch {
              Write-Host "‚ö†Ô∏è Sunshine installation had issues but continuing..."
          }

      - name: Final Setup and Info
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "üéâüéâüéâ PC-V1 SUDAH SIAP BRO! üéâüéâüéâ"
          Write-Host "========================================"
          Write-Host "üåê TAILSCALE IP: $env:TAILSCALE_IP"
          Write-Host "üë§ USERNAME: PC-V1"
          Write-Host "üîë PASSWORD: P@ssw0rd123!"
          Write-Host ""
          Write-Host "üöÄ CARA PAKE:"
          Write-Host "1. Buka REMOTE DESKTOP di Windows"
          Write-Host "2. Masukin IP: $env:TAILSCALE_IP"
          Write-Host "3. Username: PC-V1"
          Write-Host "4. Password: P@ssw0rd123!"
          Write-Host ""
          Write-Host "üéÆ UNTUK MOONLIGHT:"
          Write-Host "Buka Moonlight > Add PC > https://$env:TAILSCALE_IP:47990"
          Write-Host ""
          Write-Host "‚è∞ SESSION AKAN TETAP HIDUP SELAMA 3 HARI"
          Write-Host "========================================"

      - name: Keep Alive Forever
        shell: powershell
        run: |
          Write-Host "üîÑ KEEPING PC-V1 ALIVE..."
          $counter = 0
          while ($true) {
              $counter++
              Write-Host "[$(Get-Date)] PC-V1 NYALA - $counter menit - IP: $env:TAILSCALE_IP"
              Write-Host "üöÄ BUAT MAIN GAME: RDP ke $env:TAILSCALE_IP"
              Write-Host "üéÆ MOONLIGHT: https://$env:TAILSCALE_IP:47990"
              Start-Sleep -Seconds 60
          }