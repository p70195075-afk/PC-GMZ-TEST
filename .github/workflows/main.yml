name: PC-V1-Premium

on:
  workflow_dispatch:
    inputs:
      quality:
        description: 'Streaming Quality'
        required: true
        default: 'ultra'
        type: choice
        options:
        - balanced
        - premium
        - ultra

env:
  STREAM_QUALITY: ${{ github.event.inputs.quality || 'ultra' }}

jobs:
  premium-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: üöÄ System Optimization Premium
      shell: powershell
      run: |
        Write-Host "=== APPLYING PREMIUM SYSTEM OPTIMIZATIONS ==="
        
        try {
            Write-Host "Configuring power settings..."
            powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c | Out-Null
            powercfg /change standby-timeout-ac 0 | Out-Null
            powercfg /change monitor-timeout-ac 0 | Out-Null
            powercfg /hibernate off | Out-Null

            Write-Host "Optimizing network settings..."
            netsh int tcp set global autotuninglevel=normal | Out-Null
            netsh int tcp set global rss=enabled | Out-Null
            netsh int tcp set global chimney=enabled | Out-Null
            netsh int tcp set global dca=enabled | Out-Null
            netsh int tcp set global netdma=enabled | Out-Null

            Write-Host "Applying gaming optimizations..."
            reg add "HKLM\SYSTEM\CurrentControlSet\Control\GraphicsDrivers" /v HwSchMode /t REG_DWORD /d 2 /f | Out-Null
            reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile" /v NetworkThrottlingIndex /t REG_DWORD /d 4294967295 /f | Out-Null

            Write-Host "Optimizing services..."
            $services = @("WerSvc", "DiagTrack", "WSearch", "XboxGipSvc", "XboxNetApiSvc")
            foreach ($service in $services) {
                try {
                    $svc = Get-Service -Name $service -ErrorAction SilentlyContinue
                    if ($svc -and $svc.Status -ne "Stopped") {
                        Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
                    }
                    Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
                    Write-Host "Disabled service: $service"
                } catch {
                    Write-Host "Skipped service: $service"
                }
            }

            Write-Host "Premium system optimizations completed successfully!"
        } catch {
            Write-Host "Warning: Optimization block failed - $($_.Exception.Message)"
        }

    - name: üñ•Ô∏è Configure RDP Premium
      shell: powershell
      run: |
        Write-Host "=== CONFIGURING PREMIUM RDP ==="
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
        netsh advfirewall firewall add rule name="PC-V1-Premium-RDP" dir=in action=allow protocol=TCP localport=3389 | Out-Null
        Restart-Service -Name TermService -Force
        Write-Host "Premium RDP configured successfully!"

    - name: üë§ Create Premium User
      shell: powershell
      run: |
        Write-Host "=== CREATING PREMIUM USER ==="
        $chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*'
        $password = -join ((1..16) | ForEach-Object { $chars[(Get-Random -Maximum $chars.Length)] })
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force

        if (Get-LocalUser -Name "PC-V1-Premium" -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name "PC-V1-Premium"
            Start-Sleep -Seconds 2
        }

        New-LocalUser -Name "PC-V1-Premium" -Password $securePass -AccountNeverExpires -FullName "PC-V1 Premium Streaming"
        Add-LocalGroupMember -Group "Administrators" -Member "PC-V1-Premium"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "PC-V1-Premium"

        echo "PCV1_PASSWORD=$password" >> $env:GITHUB_ENV
        Write-Host "Premium user created successfully!"

    - name: üåê Install Tailscale
      shell: powershell
      run: |
        Write-Host "=== INSTALLING TAILSCALE ==="
        $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $file = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest -Uri $url -OutFile $file
        Start-Process msiexec.exe -ArgumentList "/i `"$file`" /quiet /norestart" -Wait
        Remove-Item $file -Force
        Write-Host "Tailscale installed successfully!"

    - name: üîó Connect Tailscale
      shell: powershell
      run: |
        Start-Service Tailscale -ErrorAction SilentlyContinue
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=pc-v1-premium
        Start-Sleep -Seconds 5
        $tsIP = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4)
        echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
        Write-Host "Connected to Tailscale - IP: $tsIP"

    - name: ‚úÖ Verify Connection
      shell: powershell
      run: |
        $test = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -InformationLevel Quiet
        if (-not $test) {
            Write-Error "RDP connection test failed!"
            exit 1
        }
        Write-Host "RDP connection verified!"

    - name: üìã Display Connection Info
      shell: powershell
      run: |
        Write-Host ""
        Write-Host "========= PC-V1 PREMIUM READY ========="
        Write-Host "Address:  $env:TAILSCALE_IP"
        Write-Host "Username: PC-V1-Premium"
        Write-Host "Password: $env:PCV1_PASSWORD"
        Write-Host "Quality:  ${{ env.STREAM_QUALITY }}"
        Write-Host "======================================"

    - name: üõ°Ô∏è Keep Alive
      shell: powershell
      run: |
        Write-Host "=== PC-V1 PREMIUM ACTIVE ==="
        for ($i = 1; $i -le 72; $i++) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Keep-alive check $i/72"
            Start-Sleep -Seconds 300
        }
