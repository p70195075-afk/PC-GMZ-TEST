name: PC-V1-Moonlight

on:
  workflow_dispatch:
    inputs:
      quality:
        description: 'Streaming Quality'
        required: true
        default: 'ultra'
        type: choice
        options:
        - balanced
        - premium
        - ultra

env:
  STREAM_QUALITY: ${{ github.event.inputs.quality || 'ultra' }}

jobs:
  moonlight-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: ğŸš€ Moonlight System Optimization
      shell: powershell
      run: |
        Write-Host "=== MOONLIGHT SYSTEM OPTIMIZATIONS ==="
        
        # Power settings for gaming
        powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        powercfg /change standby-timeout-ac 0
        powercfg /change monitor-timeout-ac 0
        powercfg /hibernate off

        # Network optimizations for streaming
        netsh int tcp set global autotuninglevel=normal
        netsh int tcp set global rss=enabled
        netsh int tcp set global chimney=enabled
        netsh int tcp set global dca=enabled
        netsh int tcp set global initialRto=1000

        # Graphics optimizations for Moonlight
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\GraphicsDrivers" /v HwSchMode /t REG_DWORD /d 2 /f
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile" /v NetworkThrottlingIndex /t REG_DWORD /d 4294967295 /f
        
        # Disable services that interfere with streaming
        $services = @("WerSvc", "DiagTrack", "WSearch", "XboxGipSvc", "XboxNetApiSvc")
        foreach ($service in $services) {
            Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
            Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
        }

        Write-Host "Moonlight optimizations completed!"

    - name: ğŸ–¥ï¸ Configure RDP for Moonlight
      shell: powershell
      run: |
        Write-Host "=== MOONLIGHT RDP CONFIGURATION ==="
        
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "TSEnabled" -Value 1 -Force
        
        # Moonlight-compatible RDP settings
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 1 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MinEncryptionLevel" -Value 1 -Force
        
        # Enhanced display settings for streaming
        Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxMonitors" -Value 4 -Force
        Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxXResolution" -Value 3840 -Force
        Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxYResolution" -Value 2160 -Force
        Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "ColorDepth" -Value 4 -Force
        
        # Firewall rules
        netsh advfirewall firewall add rule name="Moonlight-RDP" dir=in action=allow protocol=TCP localport=3389
        netsh advfirewall firewall add rule name="Moonlight-UDP" dir=in action=allow protocol=UDP localport=3389
        
        # Restart services
        Restart-Service -Name TermService -Force
        Start-Service -Name SessionEnv -ErrorAction SilentlyContinue
        
        Write-Host "Moonlight RDP configured!"

    - name: ğŸ® Moonlight-Specific Optimizations
      shell: powershell
      run: |
        Write-Host "=== MOONLIGHT STREAMING OPTIMIZATIONS ==="
        
        # Configure for Moonlight compatibility
        reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v MaxCompressionLevel /t REG_DWORD /d 1 /f
        reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v fEnableVirtualizedGraphics /t REG_DWORD /d 1 /f
        
        # Disable UDP for better stability (Moonlight works better with TCP)
        reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v SelectTransport /t REG_DWORD /d 1 /f
        
        # Enable hardware acceleration
        reg add "HKLM\SOFTWARE\Microsoft\Terminal Server Client" /v AVCHardwareEncoder /t REG_DWORD /d 1 /f
        
        Write-Host "Streaming quality set to: ${{ env.STREAM_QUALITY }}"

    - name: ğŸ‘¤ Create Gaming User (FIXED)
      shell: powershell
      run: |
        Write-Host "=== CREATING GAMING USER ==="
        
        # Generate strong password - FIXED SYNTAX
        function Generate-Password {
            $upper = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
            $lower = 'abcdefghijklmnopqrstuvwxyz' 
            $numbers = '0123456789'
            $special = '!@#$%'
            
            $passwordChars = @()
            $passwordChars += $upper.ToCharArray() | Get-Random -Count 4
            $passwordChars += $lower.ToCharArray() | Get-Random -Count 4
            $passwordChars += $numbers.ToCharArray() | Get-Random -Count 4
            $passwordChars += $special.ToCharArray() | Get-Random -Count 4
            
            # Shuffle the characters
            $shuffled = $passwordChars | Sort-Object { Get-Random }
            return -join $shuffled
        }
        
        $password = Generate-Password
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force

        # Remove existing user if any
        if (Get-LocalUser -Name "Moonlight" -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name "Moonlight"
            Start-Sleep -Seconds 2
        }

        # Create user
        New-LocalUser -Name "Moonlight" -Password $securePass -AccountNeverExpires -FullName "Moonlight Gaming"
        Add-LocalGroupMember -Group "Administrators" -Member "Moonlight"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "Moonlight"
        Add-LocalGroupMember -Group "Performance Monitor Users" -Member "Moonlight"

        echo "MOONLIGHT_PASSWORD=$password" >> $env:GITHUB_ENV
        Write-Host "Gaming user created successfully!"

    - name: ğŸŒ Install & Setup Tailscale
      shell: powershell
      run: |
        Write-Host "=== SETUP TAILSCALE ==="
        
        # Download and install
        $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
        $file = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest -Uri $url -OutFile $file
        Start-Process msiexec.exe -ArgumentList "/i `"$file`" /quiet /norestart" -Wait
        Remove-Item $file -Force
        
        # Wait for installation
        Start-Sleep -Seconds 10
        
        # Connect to Tailscale
        Start-Service Tailscale -ErrorAction SilentlyContinue
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=moonlight-pc --accept-routes --accept-dns
        
        # Get IP with retry
        $tsIP = $null
        for ($i = 1; $i -le 10; $i++) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($tsIP -and $tsIP -match '^\d+\.\d+\.\d+\.\d+$') { break }
            Start-Sleep -Seconds 3
        }
        
        if (-not $tsIP) {
            Write-Error "Failed to get Tailscale IP"
            exit 1
        }
        
        echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
        Write-Host "Tailscale connected: $tsIP"

    - name: âœ… Test Moonlight Connection
      shell: powershell
      run: |
        Write-Host "=== TESTING MOONLIGHT COMPATIBILITY ==="
        
        # Test basic RDP
        $rdpTest = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -InformationLevel Detailed
        if (-not $rdpTest.TcpTestSucceeded) {
            Write-Error "RDP connection failed!"
            exit 1
        }
        
        Write-Host "âœ“ RDP connection successful!"
        Write-Host "âœ“ Moonlight should work now!"

    - name: ğŸ“± Moonlight Setup Guide
      shell: powershell
      run: |
        Write-Host ""
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host "            ğŸ® MOONLIGHT READY ğŸ®            "
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host "ğŸŒ Address:   $env:TAILSCALE_IP"
        Write-Host "ğŸ‘¤ Username:  Moonlight"
        Write-Host "ğŸ” Password:  $env:MOONLIGHT_PASSWORD"
        Write-Host "ğŸ¯ Quality:   ${{ env.STREAM_QUALITY }}"
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host ""
        Write-Host "ğŸ“± Moonlight App Settings:"
        Write-Host "1. Add PC: $env:TAILSCALE_IP"
        Write-Host "2. Streaming: GameStream (NVIDIA) mode"
        Write-Host "3. Resolution: 1080p or 1440p"
        Write-Host "4. Bitrate: 50 Mbps"
        Write-Host "5. Frame Rate: 60 FPS"
        Write-Host ""
        Write-Host "âš ï¸  Important: Use GameStream mode"
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: ğŸ›¡ï¸ Maintain Connection
      shell: powershell
      run: |
        Write-Host "=== MOONLIGHT STREAMING ACTIVE ==="
        Write-Host "PC is ready for Moonlight connection!"
        Write-Host "IP: $env:TAILSCALE_IP"
        Write-Host "This session will run for 6 hours"
        Write-Host ""
        
        for ($hour = 1; $hour -le 6; $hour++) {
            Write-Host "[$(Get-Date -Format 'HH:mm')] Hour $hour/6 - Moonlight Ready..."
            
            # Health check every hour
            $test = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -InformationLevel Quiet
            if (-not $test) {
                Write-Host "âš ï¸  Connection issue detected, restarting RDP..."
                Restart-Service -Name TermService -Force
            }
            
            Start-Sleep -Seconds 3600  # 1 hour
        }
        
        Write-Host "Session completed successfully!"